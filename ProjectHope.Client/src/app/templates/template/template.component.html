<form [formGroup]="templateForm" novalidate (ngSubmit)="save()">
  <mat-card class="app-template mat-elevation-z0">
    <mat-card-header class="app-template__header">
      <div mat-card-avatar>
        <button mat-icon-button color="primary" type="button" (click)="close()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <mat-card-title class="app-template__header-title"
        >Template</mat-card-title
      >
      <mat-card-subtitle
        class="app-template__header-subtitle"
        [@inOutAnimation]="getAnimationState()"
      >
        {{ template?.id }}
      </mat-card-subtitle>
      <div class="app-template__header-spacer"></div>
      <div
        class="app-template__header-spinner"
        *ngIf="isLoadingResults"
        [@enterLeaveAnimation]
      >
        <mat-spinner diameter="20"></mat-spinner>
      </div>
      <button
        mat-icon-button
        color="primary"
        type="submit"
        class="app-template__header-button"
        [disabled]="
          !templateForm.valid || !templateForm.dirty || isLoadingResults
        "
      >
        <mat-icon>save</mat-icon>
      </button>
      <button
        mat-icon-button
        color="primary"
        type="button"
        class="app-template__header-button"
        [disabled]="isLoadingResults || isNew"
        (click)="delete()"
      >
        <mat-icon>delete</mat-icon>
      </button>
      <button
        mat-icon-button
        color="primary"
        type="button"
        class="app-template__header-button"
        [disabled]="isLoadingResults || isNew"
        (click)="favorite()"
      >
        <mat-icon *ngIf="!isFavorite">favorite_border</mat-icon>
        <mat-icon *ngIf="isFavorite">favorite</mat-icon>
      </button>
    </mat-card-header>
    <mat-card-content class="app-template__content">
      <mat-divider [inset]="true"></mat-divider>
      <mat-tab-group mat-stretch-tabs animationDuration="300ms">
        <mat-tab>
          <ng-template mat-tab-label>
            <span
              [class.app-template__content--warn]="
                templateForm.controls['name'].hasError('required') &&
                templateForm.controls['name'].touched
              "
            >
              Description
            </span>
          </ng-template>
          <div class="app-template__content-tab">
            <mat-form-field class="app-template__content-field">
              <mat-label>Name</mat-label>
              <input
                matInput
                formControlName="name"
                [@inOutAnimation]="getAnimationState()"
                required
              />
              <mat-error
                *ngIf="templateForm.controls['name'].hasError('required')"
              >
                Name is <strong>required</strong>
              </mat-error>
            </mat-form-field>
            <mat-form-field class="app-template__content-field">
              <mat-label>Description</mat-label>
              <textarea
                matInput
                formControlName="description"
                rows="10"
                [@inOutAnimation]="getAnimationState()"
              ></textarea>
            </mat-form-field>
          </div>
        </mat-tab>

        <mat-tab>
          <ng-template mat-tab-label>
            <span [class.app-template__content--warn]="!properties.valid">
              Properties
            </span>
          </ng-template>
          <div class="app-template__content-tab">
            <div class="app-template__content-header">
              <mat-form-field class="app-template__content-header__filter">
                <mat-label>Filter</mat-label>
                <input
                  matInput
                  (keyup)="filterProperties($event.target.value)"
                />
              </mat-form-field>
              <div class="app-template__header-spacer"></div>
              <button
                mat-icon-button
                color="primary"
                type="button"
                (click)="addProperty(null, true); updatePropertiesDataSource()"
              >
                <mat-icon>add_circle</mat-icon>
              </button>
            </div>
            <mat-divider></mat-divider>
            <table
              mat-table
              [dataSource]="propertiesDataSource"
              multiTemplateDataRows
              class="app-template__content-table"
            >
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef>Name</th>
                <td mat-cell *matCellDef="let element">
                  <div
                    class="app-template__content-table__cell-content app-template__content-table__cell-content__name"
                  >
                    {{ getSliceStr(element.controls.name.value, 20) }}
                  </div>
                </td>
              </ng-container>
              <ng-container matColumnDef="description">
                <th mat-header-cell *matHeaderCellDef>Description</th>
                <td mat-cell *matCellDef="let element">
                  <div
                    class="app-template__content-table__cell-content app-template__content-table__cell-content__description"
                  >
                    {{ getSliceStr(element.controls.description.value, 50) }}
                  </div>
                </td>
              </ng-container>
              <ng-container matColumnDef="valueType">
                <th mat-header-cell *matHeaderCellDef>Value Type</th>
                <td mat-cell *matCellDef="let element">
                  {{ element.controls.valueType.value }}
                </td>
              </ng-container>
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef></th>
                <td mat-cell *matCellDef="let element">
                  <button
                    mat-icon-button
                    color="primary"
                    type="button"
                    (click)="
                      $event.stopPropagation();
                      removePropertyElement(element);
                      updatePropertiesDataSource()
                    "
                  >
                    <mat-icon
                      matBadge="!"
                      matBadgeColor="warn"
                      [matBadgeHidden]="
                        !element.controls.name.hasError('required') &&
                        !element.controls.valueType.hasError('required')
                      "
                      >delete</mat-icon
                    >
                  </button>
                </td>
              </ng-container>

              <ng-container matColumnDef="expandedDetail">
                <td
                  mat-cell
                  *matCellDef="let element"
                  [attr.colspan]="propertiesColumnsToDisplay.length"
                  [formGroup]="element"
                >
                  <div
                    class="app-template__content-table__detail"
                    [@expandAnimation]="isPropertyExpanded(element)"
                  >
                    <mat-form-field class="app-template__content-field">
                      <mat-label>Name</mat-label>
                      <input matInput formControlName="name" required />
                      <mat-error
                        *ngIf="element.controls.name.hasError('required')"
                      >
                        Name is <strong>required</strong>
                      </mat-error>
                    </mat-form-field>
                    <mat-form-field class="app-template__content-field">
                      <mat-label>Description</mat-label>
                      <textarea
                        matInput
                        formControlName="description"
                        rows="10"
                      ></textarea>
                    </mat-form-field>
                    <mat-form-field class="app-template__content-field">
                      <mat-label>Value Type</mat-label>
                      <mat-select formControlName="valueType">
                        <mat-option
                          *ngFor="let type of valueTypes"
                          [value]="valueType[type]"
                        >
                          {{ valueType[type] }}
                        </mat-option>
                      </mat-select>
                      <mat-error
                        *ngIf="element.controls.valueType.hasError('required')"
                      >
                        Value Type is <strong>required</strong>
                      </mat-error>
                    </mat-form-field>
                  </div>
                </td>
              </ng-container>

              <tr
                mat-header-row
                *matHeaderRowDef="propertiesColumnsToDisplay"
                class="app-template__content-table__row-header"
              ></tr>
              <tr
                mat-row
                *matRowDef="let element; columns: propertiesColumnsToDisplay"
                class="app-template__content-table__row"
                [class.app-template__content-table__row--expanded]="
                  expandedProperty === element
                "
                (click)="setExpandedProperty(element)"
              ></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: ['expandedDetail']"
                class="app-template__content-table__row-detail"
              ></tr>
            </table>
          </div>
        </mat-tab>

        <!-- TODO: Elements 
        <mat-tab>
          <ng-template mat-tab-label>
            <span>
              Elements
            </span>
          </ng-template>
          <div class="app-template__content-tab">
            
          </div>
        </mat-tab>
        -->
      </mat-tab-group>
    </mat-card-content>
  </mat-card>
</form>
